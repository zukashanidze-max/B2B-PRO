import streamlit as st
import google.generativeai as genai
from PyPDF2 import PdfReader
import requests
from bs4 import BeautifulSoup

# --- рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ рЃЊрЃљ рЃЊрЃўрЃќрЃљрЃўрЃюрЃў ---
st.set_page_config(page_title="Business AI Tools", layout="wide")

# рЃњрЃЋрЃћрЃарЃЊрЃўрЃЌрЃљ рЃЏрЃћрЃюрЃўрЃБ (Sidebar)
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/4712/4712035.png", width=50)
    st.title("B2B AI рЃърЃџрЃљрЃбрЃцрЃЮрЃарЃЏрЃљ")
    st.write("рЃљрЃўрЃарЃЕрЃўрЃћ рЃўрЃюрЃАрЃбрЃарЃБрЃЏрЃћрЃюрЃбрЃў:")
    choice = st.radio("рЃЏрЃћрЃюрЃўрЃБ", ["HR & рЃбрЃарЃћрЃюрЃўрЃюрЃњрЃћрЃЉрЃў", "Sales Sniper (рЃЏрЃћрЃўрЃџрЃћрЃЉрЃў)", "рЃЎрЃЮрЃюрЃбрЃарЃљрЃЦрЃбрЃћрЃЉрЃўрЃА рЃљрЃБрЃЊрЃўрЃбрЃў"])
    
    st.divider()
    st.info("рЃерЃћрЃЦрЃЏрЃюрЃўрЃџрЃўрЃљ Gemini Pro-рЃА рЃЉрЃљрЃќрЃљрЃќрЃћ")

# --- рЃЊрЃљрЃЏрЃ«рЃЏрЃљрЃарЃћ рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў ---

# рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: Gemini-рЃАрЃЌрЃљрЃю рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃљ
def get_gemini_response(prompt, content=""):
    try:
        # рЃњрЃљрЃАрЃљрЃдрЃћрЃЉрЃўрЃА рЃгрЃљрЃЏрЃЮрЃдрЃћрЃЉрЃљ Streamlit-рЃўрЃА "рЃАрЃћрЃўрЃцрЃўрЃЊрЃљрЃю"
        api_key = st.secrets["GOOGLE_API_KEY"]
        genai.configure(api_key=api_key)
        
        model = genai.GenerativeModel('gemini-1.5-pro-latest')
        full_prompt = f"{prompt}\n\nрЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў:\n{content}"
        response = model.generate_content(full_prompt)
        return response.text
    except Exception as e:
        return f"рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: {e}. (рЃЊрЃљрЃарЃгрЃЏрЃБрЃюрЃЊрЃў рЃарЃЮрЃЏ API Key рЃАрЃгрЃЮрЃарЃљрЃЊ рЃњрЃљрЃЦрЃЋрЃА рЃерЃћрЃДрЃЋрЃљрЃюрЃўрЃџрЃў Streamlit Secrets-рЃерЃў)"

# рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: PDF-рЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃљ
def get_pdf_text(uploaded_file):
    text = ""
    pdf_reader = PdfReader(uploaded_file)
    for page in pdf_reader.pages:
        text += page.extract_text()
    return text

# рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: рЃЋрЃћрЃЉрЃАрЃљрЃўрЃбрЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃљ (Scraping)
def get_website_text(url):
    try:
        response = requests.get(url, timeout=10)
        soup = BeautifulSoup(response.content, 'html.parser')
        # рЃЋрЃўрЃдрЃћрЃЉрЃЌ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃбрЃћрЃЦрЃАрЃбрЃА
        text = ' '.join([p.get_text() for p in soup.find_all('p')])
        return text[:10000] # рЃџрЃўрЃЏрЃўрЃбрЃў рЃарЃЮрЃЏ рЃљрЃа рЃњрЃљрЃЊрЃљрЃўрЃбрЃЋрЃўрЃарЃЌрЃЮрЃА
    except:
        return "рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ рЃАрЃљрЃўрЃбрЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃљ."

# --- рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃљрЃърЃџрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ ---

# 1. HR рЃЏрЃЮрЃЊрЃБрЃџрЃў
if choice == "HR & рЃбрЃарЃћрЃюрЃўрЃюрЃњрЃћрЃЉрЃў":
    st.header("­ЪјЊ HR рЃбрЃарЃћрЃюрЃўрЃюрЃњрЃўрЃА рЃњрЃћрЃюрЃћрЃарЃљрЃбрЃЮрЃарЃў")
    st.write("рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ рЃЎрЃЮрЃЏрЃърЃљрЃюрЃўрЃўрЃА рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃў (PDF) рЃЊрЃљ AI рЃерЃћрЃњрЃўрЃЊрЃњрЃћрЃюрЃА рЃбрЃарЃћрЃюрЃўрЃюрЃњрЃА.")
    
    uploaded_file = st.file_uploader("рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ PDF рЃцрЃљрЃўрЃџрЃў", type=['pdf'])
    
    if uploaded_file is not None:
        if st.button("рЃбрЃарЃћрЃюрЃўрЃюрЃњрЃўрЃА рЃњрЃћрЃюрЃћрЃарЃљрЃфрЃўрЃљ"):
            with st.spinner('Gemini рЃЎрЃўрЃЌрЃ«рЃБрЃџрЃЮрЃЉрЃА рЃЊрЃЮрЃЎрЃБрЃЏрЃћрЃюрЃбрЃА...'):
                text = get_pdf_text(uploaded_file)
                prompt = """
                рЃерЃћрЃю рЃ«рЃљрЃа рЃњрЃљрЃЏрЃЮрЃфрЃЊрЃўрЃџрЃў HR рЃЏрЃћрЃюрЃћрЃ»рЃћрЃарЃў. рЃњрЃљрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃћ рЃћрЃА рЃбрЃћрЃЦрЃАрЃбрЃў рЃЊрЃљ рЃерЃћрЃљрЃЊрЃњрЃўрЃюрЃћ:
                1. рЃбрЃарЃћрЃюрЃўрЃюрЃњрЃўрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ (рЃЏрЃЮрЃЊрЃБрЃџрЃћрЃЉрЃў).
                2. рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃЏрЃЮрЃЊрЃБрЃџрЃўрЃА рЃЏрЃЮрЃЎрЃџрЃћ рЃерЃўрЃюрЃљрЃљрЃарЃАрЃў.
                3. 5 рЃАрЃљрЃбрЃћрЃАрЃбрЃЮ рЃерЃћрЃЎрЃўрЃЌрЃ«рЃЋрЃљ (рЃърЃљрЃАрЃБрЃ«рЃћрЃЉрЃўрЃЌ).
                рЃърЃљрЃАрЃБрЃ«рЃў рЃЊрЃљрЃгрЃћрЃарЃћ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ, рЃџрЃљрЃЏрЃљрЃќрЃљрЃЊ рЃЊрЃљрЃцрЃЮрЃарЃЏрЃћрЃЉрЃБрЃџрЃў.
                """
                response = get_gemini_response(prompt, text)
                st.markdown(response)

# 2. Sales рЃЏрЃЮрЃЊрЃБрЃџрЃў
elif choice == "Sales Sniper (рЃЏрЃћрЃўрЃџрЃћрЃЉрЃў)":
    st.header("­Ъј» рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃўрЃА рЃфрЃўрЃЋрЃў рЃЏрЃћрЃўрЃџрЃћрЃЉрЃў")
    st.write("рЃерЃћрЃўрЃДрЃЋрЃљрЃюрЃћ рЃЎрЃџрЃўрЃћрЃюрЃбрЃўрЃА рЃАрЃљрЃўрЃбрЃў рЃЊрЃљ рЃерЃћрЃюрЃў рЃерЃћрЃЌрЃљрЃЋрЃљрЃќрЃћрЃЉрЃљ.")
    
    url = st.text_input("рЃЎрЃџрЃўрЃћрЃюрЃбрЃўрЃА рЃЋрЃћрЃЉрЃАрЃљрЃўрЃбрЃўрЃА рЃџрЃўрЃюрЃЎрЃў (рЃЏрЃљрЃњ: https://example.ge)")
    offer = st.text_area("рЃерЃћрЃюрЃў рЃерЃћрЃЌрЃљрЃЋрЃљрЃќрЃћрЃЉрЃљ (рЃарЃљрЃА рЃДрЃўрЃЊрЃў?)")
    
    if st.button("рЃЏрЃћрЃўрЃџрЃўрЃА рЃЊрЃљрЃгрЃћрЃарЃљ"):
        if url and offer:
            with st.spinner('Gemini рЃАрЃгрЃљрЃЋрЃџрЃЮрЃЉрЃА рЃЎрЃџрЃўрЃћрЃюрЃбрЃўрЃА рЃЉрЃўрЃќрЃюрЃћрЃАрЃА...'):
                site_text = get_website_text(url)
                prompt = f"""
                рЃерЃћрЃю рЃ«рЃљрЃа B2B рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃўрЃА рЃћрЃЦрЃАрЃърЃћрЃарЃбрЃў. 
                
                рЃЎрЃџрЃўрЃћрЃюрЃбрЃўрЃА рЃАрЃљрЃўрЃбрЃўрЃА рЃўрЃюрЃцрЃЮ: {site_text}
                
                рЃЕрЃћрЃЏрЃў рЃерЃћрЃЌрЃљрЃЋрЃљрЃќрЃћрЃЉрЃљ: {offer}
                
                рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ: рЃЊрЃљрЃгрЃћрЃарЃћ рЃърЃћрЃарЃАрЃЮрЃюрЃљрЃџрЃўрЃќрЃћрЃЉрЃБрЃџрЃў "Cold Email" рЃљрЃЏ рЃЎрЃџрЃўрЃћрЃюрЃбрЃўрЃАрЃЌрЃЋрЃўрЃА. 
                рЃЊрЃљрЃўрЃгрЃДрЃћ рЃЎрЃЮрЃЏрЃърЃџрЃўрЃЏрЃћрЃюрЃбрЃўрЃЌ рЃЏрЃљрЃЌ рЃАрЃљрЃЦрЃЏрЃўрЃљрЃюрЃЮрЃЉрЃљрЃќрЃћ (рЃАрЃљрЃўрЃбрЃўрЃЊрЃљрЃю рЃњрЃљрЃЏрЃЮрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ), 
                рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњ рЃЉрЃБрЃюрЃћрЃЉрЃарЃўрЃЋрЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЊрЃў рЃЕрЃћрЃЏрЃА рЃерЃћрЃЌрЃљрЃЋрЃљрЃќрЃћрЃЉрЃљрЃќрЃћ. 
                рЃбрЃЮрЃюрЃў: рЃърЃарЃЮрЃцрЃћрЃАрЃўрЃЮрЃюрЃљрЃџрЃБрЃарЃў, рЃЏрЃћрЃњрЃЮрЃЉрЃарЃБрЃџрЃў, рЃљрЃарЃљ-рЃАрЃърЃљрЃЏрЃБрЃарЃў. рЃћрЃюрЃљ: рЃЦрЃљрЃарЃЌрЃБрЃџрЃў.
                """
                response = get_gemini_response(prompt, "")
                st.markdown(response)
        else:
            st.warning("рЃњрЃЌрЃ«рЃЮрЃЋ рЃерЃћрЃљрЃЋрЃАрЃЮ рЃЮрЃарЃўрЃЋрЃћ рЃЋрЃћрЃџрЃў.")

# 3. рЃЎрЃЮрЃюрЃбрЃарЃљрЃЦрЃбрЃћрЃЉрЃўрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃў
elif choice == "рЃЎрЃЮрЃюрЃбрЃарЃљрЃЦрЃбрЃћрЃЉрЃўрЃА рЃљрЃБрЃЊрЃўрЃбрЃў":
    st.header("Рџќ№ИЈ рЃЎрЃЮрЃюрЃбрЃарЃљрЃЦрЃбрЃћрЃЉрЃўрЃА рЃерЃћрЃЊрЃљрЃарЃћрЃЉрЃљ")
    st.write("рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ рЃЮрЃарЃў рЃЋрЃћрЃарЃАрЃўрЃљ рЃЊрЃљ рЃўрЃърЃЮрЃЋрЃћ рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃћрЃЉрЃў.")
    
    col1, col2 = st.columns(2)
    with col1:
        file1 = st.file_uploader("рЃЮрЃарЃўрЃњрЃўрЃюрЃљрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ", type=['pdf'], key="f1")
    with col2:
        file2 = st.file_uploader("рЃљрЃ«рЃљрЃџрЃў рЃЋрЃћрЃарЃАрЃўрЃљ (рЃърЃљрЃарЃбрЃюрЃўрЃЮрЃарЃўрЃА)", type=['pdf'], key="f2")
        
    if st.button("рЃерЃћрЃЊрЃљрЃарЃћрЃЉрЃљ"):
        if file1 and file2:
            with st.spinner('рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћрЃЮрЃЉрЃА рЃўрЃБрЃарЃўрЃЊрЃўрЃБрЃџрЃў рЃљрЃюрЃљрЃџрЃўрЃќрЃў...'):
                text1 = get_pdf_text(file1)
                text2 = get_pdf_text(file2)
                
                prompt = f"""
                рЃерЃћрЃљрЃЊрЃљрЃарЃћ рЃћрЃА рЃЮрЃарЃў рЃбрЃћрЃЦрЃАрЃбрЃў рЃћрЃарЃЌрЃЏрЃљрЃюрЃћрЃЌрЃА.
                
                рЃбрЃћрЃЦрЃАрЃбрЃў 1 (рЃЮрЃарЃўрЃњрЃўрЃюрЃљрЃџрЃў): {text1[:5000]}...
                
                рЃбрЃћрЃЦрЃАрЃбрЃў 2 (рЃљрЃ«рЃљрЃџрЃў): {text2[:5000]}...
                
                рЃўрЃърЃЮрЃЋрЃћ рЃерЃўрЃюрЃљрЃљрЃарЃАрЃЮрЃЉрЃарЃўрЃЋрЃў рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃћрЃЉрЃў. рЃЌрЃБ рЃљрЃарЃўрЃА рЃарЃўрЃАрЃЎрЃћрЃЉрЃў, рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћ.
                рЃърЃљрЃАрЃБрЃ«рЃў рЃЊрЃљрЃгрЃћрЃарЃћ рЃърЃБрЃюрЃЦрЃбрЃћрЃЉрЃљрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџ рЃћрЃюрЃљрЃќрЃћ.
                """
                response = get_gemini_response(prompt, "")
                st.markdown(response)
        else:
            st.warning("рЃљрЃбрЃЋрЃўрЃарЃЌрЃћ рЃЮрЃарЃўрЃЋрЃћ рЃцрЃљрЃўрЃџрЃў.")
